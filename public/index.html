<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <!-- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ãŸã‚ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆè¨­å®š -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .note-actions button { background: none; border: none; cursor: pointer; color: #9ca3af; }
    .note-actions button:hover { color: #1f2937; }
    #app-message {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #4CAF50; /* Green */
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }
    #app-message.error {
        background-color: #f44336; /* Red */
    }
    .note-thread {
        background-color: #ffffff;
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-lg */
        padding: 1rem; /* p-4 */
        margin-bottom: 1rem; /* space-y-4 ã®ä»£ã‚ã‚Š */
        transition: opacity 0.3s ease-in-out, background-color 0.3s ease-in-out;
        border: 1px solid transparent;
    }
    .note-thread.highlighted {
        background-color: #fffbeb;
        border-color: #fde68a;
    }
    .comment-item {
        margin-top: 0.5rem; /* space-y-2 */
        margin-left: 2.5rem; /* ml-10 */
        border-left: 2px solid #e5e7eb; /* border-l-2 border-gray-200 */
        padding-left: 1rem; /* pl-4 */
        padding-top: 0.5rem; /* pt-2 */
    }
    .comment-form-container {
        margin-top: 0.5rem;
        margin-left: 2.5rem; /* ml-10 */
        border-left: 2px solid #e5e7eb; /* border-l-2 border-gray-200 */
        padding-left: 1rem; /* pl-4 */
        padding-top: 0.5rem; /* pt-2 */
    }
    .task-button {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .task-button-actions button {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s ease-in-out;
    }
    .task-button:hover .task-button-actions button {
      visibility: visible;
      opacity: 1;
    }
    .attachment-link {
      display: inline-block;
      margin-top: 8px;
      margin-right: 8px;
      padding: 4px 8px;
      background-color: #f0f4f8;
      border-radius: 4px;
      font-size: 12px;
      color: #333;
      text-decoration: none;
    }
    .attachment-link:hover {
      background-color: #e0e8f0;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹é¸æŠç”»é¢ -->
  <div id="workspace-selector" class="hidden flex items-center justify-center h-screen">
    <div class="w-full max-w-2xl p-8 bg-white rounded-lg shadow-xl max-h-[80vh] flex flex-col">
      <h1 class="text-2xl font-bold text-center text-gray-700 mb-6">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç®¡ç†</h1>
      <div class="flex-grow overflow-y-auto pr-4">
        <div id="workspace-list" class="space-y-2"></div>
      </div>
      <div class="mt-6 pt-6 border-t">
        <h2 class="text-lg font-semibold mb-2">æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ </h2>
        <form id="add-workspace-form" class="flex items-center space-x-2">
          <input type="text" id="new-workspace-name" class="w-1/2 border rounded px-2 py-1" placeholder="è¡¨ç¤ºå (ä¾‹: Aé¡§å•å…ˆ)" required>
          <input type="text" id="new-workspace-id" class="w-1/2 border rounded px-2 py-1" placeholder="ID (ä¾‹: client_a)" required>
          <button type="submit" class="px-4 py-1 text-white bg-blue-500 rounded hover:bg-blue-600">è¿½åŠ </button>
        </form>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã®ã‚¢ãƒ—ãƒªç”»é¢ -->
  <div id="app-container" class="hidden relative h-screen w-screen overflow-x-hidden md:flex">
    <!-- Sidebar -->
    <div id="task-list-sidebar" class="absolute md:relative top-0 left-0 w-full h-full md:w-1/4 flex flex-col p-4 bg-white border-r transition-transform duration-300 ease-in-out">
      <div class="pb-4 mb-4 border-b flex justify-between items-center">
        <h2 id="workspace-title" class="text-lg font-semibold"></h2>
        <a id="home-link" href="/?admin=true" title="ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹é¸æŠã«æˆ»ã‚‹" class="text-gray-400 hover:text-blue-500"><i class="fas fa-home"></i></a>
      </div>
      <div class="flex items-center justify-between text-sm mb-2">
        <span class="font-semibold">ä½œæ¥­å†…å®¹ãƒªã‚¹ãƒˆ</span>
        <div class="flex items-center space-x-3">
          <label for="import-file-input" class="cursor-pointer text-gray-500 hover:text-green-600" title="Excel/CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ">
              <i class="fas fa-file-import"></i>
          </label>
          <input type="file" id="import-file-input" class="hidden" accept=".xlsx, .xls, .csv">
          
          <button id="toggle-archive-btn" class="text-xs text-blue-500 hover:underline">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¡¨ç¤º</button>
        </div>
      </div>
      <div id="task-buttons-container" class="flex-1 overflow-y-auto space-y-1"></div>
      <div class="mt-4 pt-4 border-t">
        <form id="add-task-form" class="space-y-2">
          <input type="text" id="new-task-name" class="w-full border rounded px-2 py-1 text-sm" placeholder="æ–°ã—ã„ä½œæ¥­å†…å®¹" required>
          <button type="submit" class="w-full px-3 py-1 text-white bg-green-600 rounded hover:bg-green-700 text-sm">ä½œæ¥­å†…å®¹ã‚’è¿½åŠ </button>
        </form>
      </div>
    </div>
    <!-- Main Content -->
    <div id="main-content-area" class="absolute md:relative top-0 left-0 w-full h-full md:w-3/4 flex flex-col p-4 bg-gray-100 transition-transform duration-300 ease-in-out translate-x-full md:translate-x-0">
      <div id="main-content-placeholder" class="flex-1 flex items-center justify-center"><p>å·¦å´ã®ãƒªã‚¹ãƒˆã‹ã‚‰ä½œæ¥­å†…å®¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p></div>
      <div id="task-notes-container" class="hidden flex flex-col h-full">
        <div class="pb-2 mb-2 border-b flex justify-between items-center">
            <div class="flex items-center">
                <button id="back-to-tasks-btn" class="mr-4 text-gray-500"><i class="fas fa-arrow-left"></i></button>
                <h1 id="task-title" class="text-xl font-bold"></h1>
                <button id="refresh-notes-btn" class="hidden ml-4 px-3 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600">
                  <i class="fas fa-sync-alt mr-1"></i>æ›´æ–°ã‚ã‚Š
            </div>
            <div><label for="author-input" class="text-sm mr-2">æŠ•ç¨¿è€…:</label><input type="text" id="author-input" class="p-1 border rounded text-sm w-32" placeholder="åå‰ã‚’å…¥åŠ›"></div>
        </div>
        <form id="note-form" class="p-4 mb-4 bg-white rounded-xl shadow-lg">
          <textarea id="note-textarea" class="w-full p-2 border rounded" placeholder="æ–°ã—ã„è©±é¡Œï¼ˆè¦ªãƒ¡ãƒ¢ï¼‰ã‚’è¿½åŠ ..." rows="2"></textarea>
          <div id="note-attachments-preview" class="mt-2 text-xs"></div>
          <div class="flex items-center justify-between mt-2">
            <div class="flex items-center space-x-2">
                <select id="status-select" class="p-2 border rounded"><option value="ä½œæ¥­ä¸­">ä½œæ¥­ä¸­</option><option value="è¦ç¢ºèª">è¦ç¢ºèª</option><option value="å®Œäº†">å®Œäº†</option></select>
                <label for="note-file-input" class="cursor-pointer p-3 text-gray-500 hover:text-blue-500" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜"><i class="fas fa-paperclip"></i></label>
                <input type="file" id="note-file-input" class="hidden" multiple>
            </div>
            <button type="submit" class="px-4 py-2 text-white bg-blue-500 rounded-lg hover:bg-blue-600 font-semibold">æ–°ã—ã„è©±é¡Œã‚’è¿½åŠ </button>
          </div>
        </form>
        <div id="notes-list" class="flex-1 overflow-y-auto pr-2"></div>
      </div>
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®è¦ç´  -->
  <div id="app-message"></div>

<!-- Firebase SDK -->
<script type="module">
Â  // Firebase SDKsã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
Â  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
Â  import { getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, deleteDoc, serverTimestamp, query, orderBy, writeBatch, getDocs, getDoc, where, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
Â  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

Â  // ã‚ãªãŸã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šæƒ…å ±
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBoPbky1S2z99_pHec1pyV3kFaXWVDOK9A",
Â  Â  authDomain: "visionapiproject-445610.firebaseapp.com",
Â  Â  projectId: "visionapiproject-445610",
Â  Â  storageBucket: "visionapiproject-445610.firebasestorage.app",
Â  Â  messagingSenderId: "467175218532",
Â  Â  appId: "1:467175218532:web:1aa10f7f01ad788232ae71",
Â  Â  measurementId: "G-NNWVP7HH14"
Â  };

Â  // (D) escapeHtml ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç§»å‹•
Â  const escapeHtml = str => { if(typeof str !== 'string')return''; const div=document.createElement('div'); div.textContent=str; return div.innerHTML; };

Â  // Firebaseã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–
Â  const app = initializeApp(firebaseConfig);
Â  const auth = getAuth(app);
Â  const db = getFirestore(app);
Â  const storage = getStorage(app);

Â  const params = new URLSearchParams(window.location.search);
Â  const workspaceId = params.get('workspace');
Â  const isAdmin = params.get('admin') === 'true';
Â  let currentUser = null;
// (B) åŒæ™‚ç·¨é›†å¯¾å¿œãƒ•ãƒ©ã‚°ã¨ä¿ç•™ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
let isEditingSomething = false;
let pendingNotesSnapshot = null; // ç·¨é›†ä¸­/ã‚³ãƒ¡ãƒ³ãƒˆä¸­ã®ä¿ç•™ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

// âœ¨ æ›´æ–°ãƒœã‚¿ãƒ³æ–¹å¼ç”¨ã®å¤‰æ•° âœ¨
let hasPendingUpdate = false;
let latestNotesSnapshot = null; // onSnapshotã§å—ã‘å–ã£ãŸæœ€æ–°ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

// (A) æœªèª­ç›£è¦–ç”¨ã®Observer
let intersectionObserver = null;
Â  // (B) åŒæ™‚ç·¨é›†å¯¾å¿œãƒ•ãƒ©ã‚°ã¨ä¿ç•™ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
Â  // (A) æœªèª­ç›£è¦–ç”¨ã®Observer

Â  const appMessage = document.getElementById('app-message');
Â  function showMessage(message, isError = false) {
Â  Â  Â  appMessage.textContent = message;
Â  Â  Â  appMessage.className = '';
Â  Â  Â  if (isError) appMessage.classList.add('error');
Â  Â  Â  appMessage.style.display = 'block';
Â  Â  Â  appMessage.style.opacity = 1;
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  appMessage.style.opacity = 0;
Â  Â  Â  Â  Â  setTimeout(() => { appMessage.style.display = 'none'; }, 500);
Â  Â  Â  }, 3000);
Â  }
Â  
Â  onAuthStateChanged(auth, user => {
Â  Â  currentUser = user;
Â  Â  const appContainer = document.getElementById('app-container');
Â  Â  const workspaceSelector = document.getElementById('workspace-selector');

Â  Â  if (user) {
Â  Â  Â  if (workspaceId) {
Â  Â  Â  Â  workspaceSelector.style.display = 'none';
Â  Â  Â  Â  appContainer.style.display = 'flex';
Â  Â  Â  Â  initializeAppLogic(user, workspaceId);
Â  Â  Â  } else if (isAdmin) {
Â  Â  Â  Â  appContainer.style.display = 'none';
Â  Â  Â  Â  workspaceSelector.style.display = 'flex';
Â  Â  Â  Â  displayWorkspaceSelector(user);
Â  Â  Â  } else {
Â  Â  Â  Â  document.body.innerHTML = `
Â  Â  Â  Â  Â  <div class="flex flex-col items-center justify-center h-screen bg-pink-50 text-gray-700 text-center p-4">
Â  Â  Â  Â  Â  Â  <i class="fas fa-user-secret fa-6x text-pink-300 mb-6 animate-bounce"></i>
Â  Â  Â  Â  Â  Â  <h1 class="text-5xl font-bold text-pink-500 mb-4">ã ã‚ã£â€¦ï¼</h1>
Â  Â  Â  Â  Â  Â  <p class="text-xl">ãã“ã¯é–‹ã‘ã¡ã‚ƒãƒ€ãƒ¡ãªæ‰‰ã§ã™â€¦ï¼</p>
Â  Â  Â  Â  Â  Â  <div class="mt-8 text-left bg-white p-6 rounded-lg shadow-md max-w-md">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg">ã“ã“ã¯ã€ç®¡ç†è€…ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ§˜ã ã‘ã®ã€<br>ã¨ã£ã¦ã‚‚ãƒ‡ãƒªã‚±ãƒ¼ãƒˆãªæƒ…å ±ãŒè©°ã¾ã£ãŸç§˜å¯†ã®å ´æ‰€ãªã‚“ã§ã™ã€‚</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-4 text-gray-600">èˆˆå‘³æœ¬ä½ã§URLã‚’æ“ä½œã—ã¦ã“ã“ã«è¾¿ã‚Šç€ã„ã¦ã—ã¾ã£ãŸã®ã ã¨æ€ã„ã¾ã™ãŒã€<br>ä¸­ã‚’è¦—ãã®ã¯ã€ã©ã†ã‹ã”é æ…®ãã ã•ã„ã­â€¦æ¥ãšã‹ã—ã„ã®ã§â€¦ã€‚</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-6 text-sm text-pink-400 font-semibold">(ã‚‚ã—æ‹›å¾…ã•ã‚ŒãŸã”æœ¬äººæ§˜ã§ã—ãŸã‚‰ã€ãŠæ¸¡ã—ã—ãŸæ­£ã—ã„URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ã­ ğŸ¤«)</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  signInAnonymously(auth).catch(error => {
Â  Â  Â  Â  console.error("Anonymous sign-in failed:", error);
Â  Â  Â  Â  document.body.innerHTML = `<div class="flex items-center justify-center h-screen"><div class="text-center p-8 bg-white rounded-lg shadow-lg"><h1 class="text-2xl font-bold text-red-600 mb-4">èªè¨¼ã‚¨ãƒ©ãƒ¼</h1><p>Firebaseã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p></div></div>`;
Â  Â  Â  });
Â  Â  }
Â  });

Â  // --- ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ç®¡ç†æ©Ÿèƒ½ ---
Â  async function displayWorkspaceSelector(user) {
Â  Â  const listElement = document.getElementById('workspace-list');
Â  Â  const addWorkspaceForm = document.getElementById('add-workspace-form');
Â  Â  
Â  Â  onSnapshot(query(collection(db, "workspaces"), orderBy("name")), (querySnapshot) => {
Â  Â  Â  listElement.innerHTML = '';
Â  Â  Â  if (querySnapshot.empty) {
Â  Â  Â  Â  listElement.innerHTML = '<p class="text-center text-gray-500">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  querySnapshot.forEach((doc) => {
Â  Â  Â  Â  const workspace = { id: doc.id, ...doc.data() };
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
Â  Â  Â  Â  
Â  Â  Â  Â  // (A) ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®æœªèª­ãƒ­ã‚¸ãƒƒã‚¯
Â  Â  Â  Â  const lastViewed = localStorage.getItem(`lastViewed_workspace_${workspace.id}`) || 0;
Â  Â  Â  Â  const lastUpdatedMillis = workspace.lastUpdated ? workspace.lastUpdated.toMillis() : 0;
Â  Â  Â  Â  const isUnread = lastUpdatedMillis > lastViewed && workspace.lastUpdatedBy !== user.uid;
Â  Â  Â  Â  const indicatorHtml = isUnread ? `<span class="text-red-500 ml-2 unread-indicator">â—</span>` : '';

Â  Â  Â  Â  // (D) escapeHtml ã‚’ä½¿ç”¨
Â  Â  Â div.innerHTML = `
  <div class="flex items-baseline space-x-2 min-w-0">
    <a href="?workspace=${workspace.id}" class="workspace-link font-semibold text-blue-600 hover:underline truncate" data-id="${workspace.id}">
      ${escapeHtml(workspace.name)} ${indicatorHtml}
    </a>
    <span class="text-xs text-gray-500">ID: ${escapeHtml(workspace.id)}</span>
  </div>
  <div class="space-x-2">
    <button class="edit-workspace-btn text-gray-400 hover:text-green-500" data-id="${workspace.id}" data-name="${workspace.name}"><i class="fas fa-pencil-alt"></i></button>
    <button class="delete-workspace-btn text-gray-400 hover:text-red-500" data-id="${workspace.id}" data-name="${workspace.name}"><i class="fas fa-trash-alt"></i></button>
  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  listElement.appendChild(div);
Â  Â  Â  });
Â  Â  }, (error) => {
Â  Â  Â  console.error("Error loading workspaces: ", error);
Â  Â  Â  listElement.innerHTML = '<p class="text-center text-red-500">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
Â  Â  });

Â  Â  addWorkspaceForm.addEventListener('submit', async (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const nameInput = document.getElementById('new-workspace-name');
Â  Â  Â  const idInput = document.getElementById('new-workspace-id');
Â  Â  Â  const name = nameInput.value.trim();
Â  Â  Â  const id = idInput.value.trim().replace(/\s+/g, '-');
Â  Â  Â  if (!name || !id) return;
Â  Â  Â  
Â  Â  Â  try {
Â  Â  Â  Â  // (A) ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆæ™‚ã«ã‚‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä¿å­˜
Â  Â  Â  Â  await setDoc(doc(db, "workspaces", id), { name: name, lastUpdated: serverTimestamp(), lastUpdatedBy: user.uid });
Â  Â  Â  Â  nameInput.value = '';
Â  Â  Â  Â  idInput.value = '';
Â  Â  Â  Â  showMessage('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error adding workspace:", error);
Â  Â  Â  Â  showMessage('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
Â  Â  Â  }
Â  Â  });

Â  Â  listElement.addEventListener('click', async (e) => {
Â  Â  Â  const editBtn = e.target.closest('.edit-workspace-btn');
Â  Â  Â  const deleteBtn = e.target.closest('.delete-workspace-btn');
Â  Â  Â  const workspaceLink = e.target.closest('.workspace-link');
Â  Â  Â  
Â  Â  Â  if (workspaceLink) {
Â  Â  Â  Â  // (A) ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ—¢èª­åŒ–
Â  Â  Â  Â  const id = workspaceLink.dataset.id;
Â  Â  Â  Â  localStorage.setItem(`lastViewed_workspace_${id}`, Date.now());
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  if (editBtn) {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  const id = editBtn.dataset.id;
Â  Â  Â  Â  const currentName = editBtn.dataset.name;
Â  Â  Â  Â  const newName = prompt("æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", currentName);
Â  Â  Â  Â  if (newName && newName.trim() !== '') {
Â  Â  Â  Â  Â  // (A) ç·¨é›†æ™‚ã«ã‚‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
Â  Â  Â  Â  Â  await updateDoc(doc(db, "workspaces", id), { name: newName.trim(), lastUpdated: serverTimestamp(), lastUpdatedBy: user.uid });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  if (deleteBtn) {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  const id = deleteBtn.dataset.id;
Â  Â  Â  Â  const name = deleteBtn.dataset.name;
Â  Â  Â  Â  if (confirm(`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`)) {
Â  Â  Â  Â  Â  await deleteDoc(doc(db, "workspaces", id));
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  }

Â  // --- ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªãƒ­ã‚¸ãƒƒã‚¯ ---
Â  async function initializeAppLogic(user, workspaceId) {
Â  Â  let currentTask = null;
Â  Â  let unsubscribeNotes = null;
Â  Â  let allTasks = [];
Â  Â  let showArchived = false;
Â  Â  let noteFiles = [];
Â  Â  let commentFiles = {};

Â  Â  const authorInput = document.getElementById('author-input');
Â  Â  const taskListSidebar = document.getElementById('task-list-sidebar');
Â  Â  const mainContentArea = document.getElementById('main-content-area');
Â  Â  const taskButtonsContainer = document.getElementById('task-buttons-container');
Â  Â  const mainContentPlaceholder = document.getElementById('main-content-placeholder');
Â  Â  const taskNotesContainer = document.getElementById('task-notes-container');
Â  Â  const taskTitle = document.getElementById('task-title');
Â  Â  const notesList = document.getElementById('notes-list');
Â  Â  const noteForm = document.getElementById('note-form');
Â  Â  const addTaskForm = document.getElementById('add-task-form');
Â  Â  const toggleArchiveBtn = document.getElementById('toggle-archive-btn');
Â  Â  const noteFileInput = document.getElementById('note-file-input');
Â  Â  const noteAttachmentsPreview = document.getElementById('note-attachments-preview');
Â  Â  const backToTasksBtn = document.getElementById('back-to-tasks-btn');
Â  Â  const homeLink = document.getElementById('home-link');

Â  Â  if (!isAdmin) {
Â  Â  Â  homeLink.style.display = 'none';
Â  Â  }

Â  Â  const workspaceRef = doc(db, "workspaces", workspaceId);
Â  Â  try {
Â  Â  Â  Â  const workspaceDoc = await getDoc(workspaceRef);
Â  Â  Â  Â  if (workspaceDoc.exists()) {
Â  Â  Â  Â  Â  Â  document.getElementById('workspace-title').textContent = workspaceDoc.data().name;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById('workspace-title').textContent = `${workspaceId} (ä¸æ˜)`;
Â  Â  Â  Â  }
Â  Â  } catch {
Â  Â  Â  Â  document.getElementById('workspace-title').textContent = `${workspaceId} (ã‚¨ãƒ©ãƒ¼)`;
Â  Â  }

Â  Â  authorInput.value = localStorage.getItem('memoAuthor') || '';
Â  Â  authorInput.addEventListener('change', () => localStorage.setItem('memoAuthor', authorInput.value));
Â  Â  
Â  Â  // (D) escapeHtmlã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç§»å‹•æ¸ˆã¿
Â  Â  const getStatusIcon = status => { switch (status) { case 'ä½œæ¥­ä¸­': return '<i class="fas fa-cogs text-blue-500"></i>'; case 'è¦ç¢ºèª': return '<i class="fas fa-exclamation-triangle text-yellow-500"></i>'; case 'å®Œäº†': return '<i class="fas fa-check-circle text-green-500"></i>'; default: return ''; } };

Â  Â  const tasksCollectionRef = collection(db, "workspaces", workspaceId, "tasks");
Â  Â  
Â  Â  onSnapshot(query(tasksCollectionRef, orderBy("createdAt", "desc")), (snapshot) => {
Â  Â  Â  Â  allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  displayTasks();
Â  Â  });

Â  Â  toggleArchiveBtn.addEventListener('click', () => {
Â  Â  Â  Â  showArchived = !showArchived;
Â  Â  Â  Â  toggleArchiveBtn.textContent = showArchived ? 'é€šå¸¸è¡¨ç¤º' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¡¨ç¤º';
Â  Â  Â  Â  displayTasks();
Â  Â  });

Â  Â  // (B) ç·¨é›†çŠ¶æ…‹ç®¡ç†ã¨ä¿ç•™ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå‡¦ç†
Â  Â  function setEditingStatus(isEditing) {
Â  Â  Â  Â  isEditingSomething = isEditing;
Â  Â  Â  Â  
Â  Â  Â  Â  // ç·¨é›†ãŒçµ‚äº†ã—ã€ä¿ç•™ä¸­ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒã‚ã‚‹å ´åˆ
Â  Â  Â  Â  if (!isEditing && pendingNotesSnapshot) {
Â  Â  Â  Â  Â  Â  console.log("Applying pending snapshot...");
Â  Â  Â  Â  Â  Â  handleNotesSnapshot(pendingNotesSnapshot);
Â  Â  Â  Â  Â  Â  pendingNotesSnapshot = null;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function displayTasks() {
Â  Â  Â  Â  const tasksToDisplay = allTasks.filter(task => showArchived ? task.archived : !task.archived);
Â  Â  Â  Â  taskButtonsContainer.innerHTML = '';
Â  Â  Â  Â  if (tasksToDisplay.length === 0) {
Â  Â  Â  Â  Â  Â  taskButtonsContainer.innerHTML = `<p class="text-xs text-gray-500 p-2">${showArchived ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸä½œæ¥­ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' : 'ä½œæ¥­å†…å®¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚'}</p>`;
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  tasksToDisplay.forEach(task => taskButtonsContainer.appendChild(createTaskButton(task)));
Â  Â  }

Â  function createTaskButton(task) {
        const button = document.createElement('div');
        button.className = 'task-button w-full text-left p-2 text-sm rounded-lg hover:bg-gray-100 cursor-pointer';
        if (currentTask && currentTask.id === task.id) button.classList.add('bg-blue-100', 'text-blue-800', 'font-semibold');
        
        // (A) ã‚¿ã‚¹ã‚¯ã®æœªèª­ãƒ­ã‚¸ãƒƒã‚¯
        const lastViewed = localStorage.getItem(`lastViewed_${workspaceId}_${task.id}`) || 0;
        const lastUpdatedMillis = task.lastUpdated ? task.lastUpdated.toMillis() : (task.createdAt ? task.createdAt.toMillis() : 0);
        const isUnread = lastUpdatedMillis > lastViewed && task.lastUpdatedBy !== user.uid;
        const indicatorHtml = isUnread ? `<span class="text-red-500 ml-2 unread-indicator">â—</span>` : '';

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸæ‹…å½“è€…åãŒã‚ã‚Œã°è¡¨ç¤º
        const authorHtml = task.importedAuthor ? `<span class="text-xs text-gray-400 ml-1">(${escapeHtml(task.importedAuthor)})</span>` : '';

        button.innerHTML = `
        <span class="flex items-center flex-wrap">
            ${escapeHtml(task.name)} 
            ${authorHtml}
            ${indicatorHtml}
        </span>

        <div class="task-button-actions flex items-center">
            <button title="åç§°å¤‰æ›´" class="edit-task-btn text-gray-400 hover:text-green-500 mr-2" data-id="${task.id}" data-name="${task.name}"><i class="fas fa-pencil-alt"></i></button>
            
            <button title="${task.archived ? 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è§£é™¤' : 'ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–'}" class="archive-task-btn text-gray-400 hover:text-yellow-500 mr-2" data-id="${task.id}" data-archived="${task.archived || false}"><i class="fas fa-archive"></i></button>
            <button title="å‰Šé™¤" class="delete-task-btn text-gray-400 hover:text-red-500" data-id="${task.id}" data-name="${task.name}"><i class="fas fa-trash-alt"></i></button>
        </div>
        `;
        button.onclick = (e) => {
            if (!e.target.closest('button')) selectTask(task);
        };
        return button;
    }

    Â  taskButtonsContainer.addEventListener('click', async (e) => {
        const archiveBtn = e.target.closest('.archive-task-btn');
        const deleteBtn = e.target.closest('.delete-task-btn');
        const editBtn = e.target.closest('.edit-task-btn'); // â˜…è¿½åŠ 

        // â˜…è¿½åŠ : åç§°å¤‰æ›´å‡¦ç†
        if (editBtn) {
            e.stopPropagation(); // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚¿ã‚¹ã‚¯é¸æŠã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
            const id = editBtn.dataset.id;
            const currentName = editBtn.dataset.name;
            const newName = prompt("æ–°ã—ã„ä½œæ¥­å†…å®¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", currentName);
            
            if (newName && newName.trim() !== '' && newName !== currentName) {
                try {
                    // ã‚¿ã‚¹ã‚¯åã‚’æ›´æ–°
                    await updateDoc(doc(tasksCollectionRef, id), { 
                        name: newName.trim(), 
                        lastUpdated: serverTimestamp(), 
                        lastUpdatedBy: user.uid 
                    });
                    // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®æ›´æ–°æ—¥æ™‚ã‚‚æ›´æ–°ï¼ˆä¸¦ã³é †ãªã©ã®ãŸã‚ï¼‰
                    await updateDoc(workspaceRef, { lastUpdated: serverTimestamp(), lastUpdatedBy: user.uid });
                } catch (error) {
                    console.error("Error updating task name:", error);
                    showMessage('åç§°ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
                }
            }
        }

        if (archiveBtn) {
            e.stopPropagation();
            const id = archiveBtn.dataset.id;
            const isArchived = archiveBtn.dataset.archived === 'true';
            // (A) ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ™‚ã‚‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
            await updateDoc(doc(tasksCollectionRef, id), { 
                archived: !isArchived, 
                lastUpdated: serverTimestamp(), 
                lastUpdatedBy: user.uid 
            });
            // (E) ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚æ›´æ–°
            await updateDoc(workspaceRef, { lastUpdated: serverTimestamp(), lastUpdatedBy: user.uid });
        }

        if (deleteBtn) {
            e.stopPropagation();
            const id = deleteBtn.dataset.id;
            const name = deleteBtn.dataset.name;
            if (confirm(`ä½œæ¥­å†…å®¹ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                await deleteDoc(doc(tasksCollectionRef, id));
                // (E) ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚æ›´æ–°
                await updateDoc(workspaceRef, { lastUpdated: serverTimestamp(), lastUpdatedBy: user.uid });
            }
        }
    });

Â  Â  function selectTask(task) {
Â  Â  Â  Â  currentTask = task;
Â  Â  Â  Â  // (A) ã‚¿ã‚¹ã‚¯æ—¢èª­åŒ–
Â  Â  Â  Â  localStorage.setItem(`lastViewed_${workspaceId}_${task.id}`, Date.now());
Â  Â  Â  Â  displayTasks();
Â  Â  Â  Â  mainContentPlaceholder.classList.add('hidden');
Â  Â  Â  Â  taskNotesContainer.classList.remove('hidden');
Â  Â  Â  Â  taskTitle.textContent = task.name + ' - ä½œæ¥­ãƒ¡ãƒ¢';
Â  Â  Â  Â  
Â  Â  Â  Â  if (window.innerWidth < 768) {
Â  Â  Â  Â  Â  Â  taskListSidebar.classList.add('-translate-x-full');
Â  Â  Â  Â  Â  Â  mainContentArea.classList.remove('translate-x-full');
Â  Â  Â  Â  }

Â  Â  Â  Â  loadNotes(task.id);
Â  Â  }

Â  Â  backToTasksBtn.addEventListener('click', () => {
Â  Â  Â  Â  taskListSidebar.classList.remove('-translate-x-full');
Â  Â  Â  Â  mainContentArea.classList.add('translate-x-full');
Â  Â  });

Â  Â  // (B) ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆå‡¦ç†ã‚’åˆ¥é–¢æ•°ã«åˆ†é›¢
Â  Â  function handleNotesSnapshot(snapshot) {
Â  Â  Â  Â  const notesMap = new Map();
Â  Â  Â  Â  const parentNotes = [];
Â  Â  Â  Â  snapshot.docs.forEach(doc => notesMap.set(doc.id, { id: doc.id, ...doc.data(), replies: [] }));
Â  Â  Â  Â  for (const note of notesMap.values()) {
Â  Â  Â  Â  Â  Â  if (note.parentId && notesMap.has(note.parentId)) {
Â  Â  Â  Â  Â  Â  Â  Â  notesMap.get(note.parentId).replies.push(note);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  parentNotes.push(note);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  parentNotes.sort((a, b) => {
Â  Â  Â  Â  Â  Â  // (A) ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ã« lastUpdatedAt ã‚’è¿½åŠ  (ãªã„å ´åˆã¯ createdAt)
Â  Â  Â  Â  Â  Â  const aTime = (a.lastUpdatedAt || a.createdAt)?.toMillis() || 0;
Â  Â  Â  Â  Â  Â  const bTime = (b.lastUpdatedAt || b.createdAt)?.toMillis() || 0;
Â  Â  Â  Â  Â  Â  return (a.isHighlighted ? -1 : 1) - (b.isHighlighted ? -1 : 1) || (a.status === 'å®Œäº†' ? 1 : 0) - (b.status === 'å®Œäº†' ? 1 : 0) || bTime - aTime;
Â  Â  Â  Â  });
Â  Â  Â  Â  displayNotes(parentNotes);
Â  Â  }

Â  function loadNotes(taskId) {
        if (unsubscribeNotes) unsubscribeNotes();
        notesList.innerHTML = '<div class="text-center p-4">èª­ã¿è¾¼ã¿ä¸­...</div>';
        const refreshBtn = document.getElementById('refresh-notes-btn');
        refreshBtn.classList.add('hidden');
        hasPendingUpdate = false;
        latestNotesSnapshot = null; // åˆå›èª­ã¿è¾¼ã¿åˆ¤å®šç”¨ã«nullåˆæœŸåŒ–

        const notesQuery = query(collection(db, "workspaces", workspaceId, "tasks", taskId, "notes"), orderBy("createdAt", "asc"));

        unsubscribeNotes = onSnapshot(notesQuery, (snapshot) => {
            // (B) ç·¨é›†ä¸­ã¯å¸¸ã«ä¿ç•™
            if (isEditingSomething) {
                console.log("Pending snapshot while editing...");
                pendingNotesSnapshot = snapshot;
                return;
            }

            // åˆå›èª­ã¿è¾¼ã¿æ™‚
            if (!latestNotesSnapshot) {
                console.log("Initial load, rendering immediately.");
                latestNotesSnapshot = snapshot; // æœ€æ–°çŠ¶æ…‹ã‚’ä¿æŒ
                handleNotesSnapshot(snapshot);
                return; // åˆå›æç”»å®Œäº†
            }

            // --- 2å›ç›®ä»¥é™ã®æ›´æ–°å‡¦ç† ---

            // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã«å·®åˆ†ãŒã‚ã‚‹ã‹ã€ã¾ãŸã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ãŒå¤‰ã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
            // (docChanges() ãŒç©ºã§ã‚‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°ãŒå¤‰ã‚ã£ã¦ã„ã‚Œã°æ›´æ–°ãŒå¿…è¦)
            if (snapshot.docChanges().length > 0 || snapshot.size !== latestNotesSnapshot.size) {
                 // ä»Šå›ã®å¤‰æ›´ã«è‡ªåˆ†ã®æ›´æ–°ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                let isMyUpdateIncluded = false;
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    // lastUpdatedBy ãŒè‡ªåˆ†ã®UIDã¨ä¸€è‡´ã™ã‚‹ã‹ç¢ºèª
                    if (data && data.lastUpdatedBy === currentUser.uid) {
                        isMyUpdateIncluded = true;
                    }
                });

                latestNotesSnapshot = snapshot; // å¸¸ã«æœ€æ–°ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿æŒ

                if (isMyUpdateIncluded) {
                    // è‡ªåˆ†ã®å¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³æ™‚æç”»
                    console.log("My update detected, rendering immediately.");
                    handleNotesSnapshot(snapshot);
                     // ã‚‚ã—æ›´æ–°ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãŸã‚‰éš ã™ï¼ˆè‡ªåˆ†ã®æ“ä½œç›´å¾Œã«ä»–äººã®æ›´æ–°é€šçŸ¥ãŒå‡ºã‚‹ã®ã‚’é˜²ãï¼‰
                    refreshBtn.classList.add('hidden');
                    hasPendingUpdate = false;
                } else {
                    // ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹å¤‰æ›´ã®ã¿ã®å ´åˆ
                    console.log("Other user's update detected, showing refresh button.");
                    hasPendingUpdate = true;
                    refreshBtn.classList.remove('hidden');
                }
            } else {
                 // ãƒ‡ãƒ¼ã‚¿å†…å®¹ã«å·®åˆ†ãŒãªã„å ´åˆ (ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å¤‰æ›´ãªã©) ã¯ä½•ã‚‚ã—ãªã„
                console.log("Snapshot received, but no document changes detected.");
            }
        });
    }

Â  Â  // (A) æœªèª­ç›£è¦– (IntersectionObserver)
function observeVisibleNotes() {
    if (intersectionObserver) {
        intersectionObserver.disconnect();
    }

    intersectionObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const noteElement = entry.target;
                const noteId = noteElement.dataset.noteId;
                const updatedAt = noteElement.dataset.updatedAt;

                if (noteId && updatedAt) {
                    const key = `lastViewed_note_${workspaceId}_${currentTask.id}_${noteId}`;
                    // ğŸ‘‡ localStorageã®æ›´æ–°ã®ã¿è¡Œã†
                    localStorage.setItem(key, updatedAt);
                    // ğŸ‘‡ èµ¤å°ã‚’ç›´æ¥å‰Šé™¤ã™ã‚‹å‡¦ç†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆã¾ãŸã¯å‰Šé™¤ï¼‰
                    // noteElement.querySelectorAll('.unread-indicator').forEach(el => el.remove());
                    intersectionObserver.unobserve(noteElement);
                }
            }
        });
    }, { threshold: 0.1 });

    // .unread-indicator ã‚’æŒã¤è¦ç´ ã‚’ *å«ã‚€*ã€[data-note-id] å±æ€§ã‚’æŒã¤è¦ç´ ã‚’ç›£è¦–
    document.querySelectorAll('.unread-indicator').forEach(indicator => {
        const noteElement = indicator.closest('[data-note-id]');
        if (noteElement) {
            intersectionObserver.observe(noteElement);
        }
    });
}

Â  Â  // (A) `displayNotes`
Â  Â  function displayNotes(parentNotes) {
Â  Â  Â  Â  notesList.innerHTML = '';
Â  Â  Â  Â  if (parentNotes.length === 0) {
Â  Â  Â  Â  Â  Â  notesList.innerHTML = '<div class="text-center p-4">ã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  parentNotes.forEach(note => {
Â  Â  Â  Â  Â  Â  const noteThreadContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  noteThreadContainer.className = `note-thread ${note.status === 'å®Œäº†' ? 'opacity-50' : ''} ${note.isHighlighted ? 'highlighted' : ''}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // (A) è¦ªãƒ¡ãƒ¢ã®æœªèª­åˆ¤å®š
Â  Â  Â  Â  Â  Â const lastViewedParent = Number(localStorage.getItem(`lastViewed_note_${workspaceId}_${currentTask.id}_${note.id}`) || 0);
    const lastUpdatedParentMillis = (note.lastUpdatedAt || note.createdAt)?.toMillis() || 0;
    const isParentUnread = lastUpdatedParentMillis > lastViewedParent && note.lastUpdatedBy !== user.uid;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  noteThreadContainer.appendChild(createParentNoteElement(note, isParentUnread, lastUpdatedParentMillis));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  note.replies.forEach(reply => {
Â  Â  Â  Â  Â  Â  Â  Â  // (A) ã‚³ãƒ¡ãƒ³ãƒˆã®æœªèª­åˆ¤å®š
Â  Â  Â  Â  Â  Â  Â  Â  const lastViewedComment = Number(localStorage.getItem(`lastViewed_note_${workspaceId}_${currentTask.id}_${reply.id}`) || 0);
        const lastUpdatedCommentMillis = (reply.lastUpdatedAt || reply.createdAt)?.toMillis() || 0;
        const isCommentUnread = lastUpdatedCommentMillis > lastViewedComment && reply.lastUpdatedBy !== user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  noteThreadContainer.appendChild(createCommentElement(reply, isCommentUnread, lastUpdatedCommentMillis));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  noteThreadContainer.appendChild(createCommentFormElement(note.id));
Â  Â  Â  Â  Â  Â  notesList.appendChild(noteThreadContainer);
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // (A) æç”»å¾Œã«æœªèª­ç›£è¦–ã‚’é–‹å§‹
Â  Â  Â  Â  observeVisibleNotes();
Â  Â  }

Â  Â  // (A) `createParentNoteElement` ã‚’ä¿®æ­£ï¼ˆdata-* å±æ€§ã‚’ä»˜ä¸ï¼‰
Â function createParentNoteElement(note, isUnread, lastUpdatedMillis) {
    const noteContainer = document.createElement('div');
    noteContainer.id = `note-${note.id}`;
    noteContainer.dataset.noteId = note.id;
    noteContainer.dataset.updatedAt = lastUpdatedMillis;

    const timestamp = note.createdAt ? note.createdAt.toDate().toLocaleString('ja-JP') : '';
    const attachmentsHtml = (note.attachments || []).map(file => `
        <a href="${file.url}" target="_blank" class="attachment-link"><i class="fas fa-file-alt mr-1"></i>${escapeHtml(file.name)}</a>
    `).join('');
    const highlightClass = note.isHighlighted ? 'text-yellow-500' : 'text-gray-400';

    // (A) æœªèª­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼HTML
    const indicatorHtml = isUnread ? `<span class="unread-indicator text-red-500 mr-1">â—</span>` : '';

    noteContainer.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="status-icon pt-1">${getStatusIcon(note.status)}</div>
            <div class="flex-1 min-w-0">
                <p class="text-gray-800 whitespace-pre-wrap note-content">${escapeHtml(note.content)}</p>
                <div>${attachmentsHtml}</div>
                <div class="flex items-center justify-between text-xs text-gray-500 mt-2 pt-2 border-t">
                    
                    <span class="flex items-center">
                        ${indicatorHtml}
                        <span>by: ${escapeHtml(note.author)}</span>
                    </span>
                    <span>${timestamp}</span>
                </div>
            </div>
            <div class="flex flex-col items-end space-y-2">
                <select class="status-changer border rounded text-xs p-1" data-note-id="${note.id}">
                    <option value="ä½œæ¥­ä¸­" ${note.status === 'ä½œæ¥­ä¸­' ? 'selected' : ''}>ä½œæ¥­ä¸­</option>
                    <option value="è¦ç¢ºèª" ${note.status === 'è¦ç¢ºèª' ? 'selected' : ''}>è¦ç¢ºèª</option>
                    <option value="å®Œäº†" ${note.status === 'å®Œäº†' ? 'selected' : ''}>å®Œäº†</option>
                </select>
                <div class="note-actions flex items-center space-x-2">
                    <button class="highlight-btn ${highlightClass} hover:text-yellow-500" data-note-id="${note.id}" title="æ³¨ç›®"><i class="fas fa-star"></i></button>
                    ${createButtonHtml('edit-btn', 'fa-pencil-alt', note.id)}
                    ${createButtonHtml('delete-btn', 'fa-trash-alt', note.id)}
                </div>
            </div>
        </div>`;
    return noteContainer;
}

Â  Â  // (A) `createCommentElement` ã‚’ä¿®æ­£ï¼ˆdata-* å±æ€§ã‚’ä»˜ä¸ï¼‰
Â  function createCommentElement(comment, isUnread, lastUpdatedMillis) {
    const div = document.createElement('div');
    div.id = `note-${comment.id}`;
    div.className = 'comment-item p-3 bg-white rounded-xl text-sm';
    div.dataset.noteId = comment.id;
    div.dataset.updatedAt = lastUpdatedMillis;

    const timestamp = comment.createdAt ? comment.createdAt.toDate().toLocaleString('ja-JP') : '';
    const attachmentsHtml = (comment.attachments || []).map(file => `
        <a href="${file.url}" target="_blank" class="attachment-link"><i class="fas fa-file-alt mr-1"></i>${escapeHtml(file.name)}</a>
    `).join('');

    // (A) æœªèª­ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼HTML
    const indicatorHtml = isUnread ? `<span class="unread-indicator text-red-500 mr-1">â—</span>` : '';

    div.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="pt-1"><i class="fas fa-comment-dots text-gray-400"></i></div>
            <div class="flex-1 min-w-0">
                <p class="text-gray-700 whitespace-pre-wrap note-content">${escapeHtml(comment.content)}</p>
                <div>${attachmentsHtml}</div>
                <div class="flex items-center justify-between text-xs text-gray-500 mt-2 pt-2 border-t border-dashed">
                  
                    <span class="flex items-center">
                        ${indicatorHtml}
                        <span>by: ${escapeHtml(comment.author)}</span>
                    </span>
                    <span>${timestamp}</span>
                </div>
            </div>
            <div class="note-actions space-x-2">${createButtonHtml('edit-btn', 'fa-pencil-alt', comment.id)}${createButtonHtml('delete-btn', 'fa-trash-alt', comment.id)}</div>
        </div>`;
    return div;
}

Â  Â function createCommentFormElement(parentId) {
    const div = document.createElement('div');
    // ğŸ‘‡ ä¿®æ­£ç®‡æ‰€: flex-shrink-0 ã‚’ã‚¯ãƒ©ã‚¹ã«è¿½åŠ 
    div.className = 'comment-form-container flex-shrink-0'; // è¦ªè¦ç´ ãŒflexã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã«ä¼¸ã³ã‚‹ã®ã‚’é˜²ã
    div.innerHTML = `
        <form class="comment-form" data-parent-id="${parentId}">
            <div class="relative">
                <input type="text" class="comment-input w-full border rounded px-2 py-1 text-sm" placeholder="è¿½åŠ ã‚³ãƒ¡ãƒ³ãƒˆ...">
                <button type="button" class="quick-reply-btn absolute right-2 top-1/2 -translate-y-1/2 text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded hover:bg-gray-300">äº†è§£ã§ã™</button>
            </div>
            <div class="comment-attachments-preview mt-2 text-xs"></div>
            <div class="flex items-center justify-end space-x-2 mt-2">
                <label class="cursor-pointer text-gray-500 hover:text-blue-500"><i class="fas fa-paperclip"></i>
                    <input type="file" class="comment-file-input hidden" multiple>
                </label>
                <button type="submit" class="px-3 py-1 text-white bg-gray-500 rounded hover:bg-gray-600 text-sm">é€ä¿¡</button>
            </div>
        </form>`;
    return div;
}

const createButtonHtml = (className, icon, noteId) => `<button class="${className}" data-note-id="${noteId}" title="${className === 'edit-btn' ? 'ç·¨é›†' : 'å‰Šé™¤'}"><i class="fas ${icon}"></i></button>`;
Â  Â  
Â  Â  // (E) updateTaskTimestamp ã‚’æ”¹ä¿®
Â  Â  async function updateTaskTimestamp(taskId, noteIdToUpdate = null) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  const updateData = {
Â  Â  Â  Â  Â  Â  Â  Â  lastUpdated: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedBy: user.uid
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 1. ã‚¿ã‚¹ã‚¯è‡ªä½“ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  const taskRef = doc(tasksCollectionRef, taskId);
Â  Â  Â  Â  Â  Â  batch.update(taskRef, updateData);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 2. ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  batch.update(workspaceRef, updateData);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 3. (E) æŒ‡å®šã•ã‚ŒãŸè¦ªãƒ¡ãƒ¢ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚‚æ›´æ–°
Â  Â  Â  Â  Â  Â  if (noteIdToUpdate) {
Â  Â  Â  Â  Â  Â  Â  Â  const noteRef = doc(db, "workspaces", workspaceId, "tasks", taskId, "notes", noteIdToUpdate);
Â  Â  Â  Â  Â  Â  Â  Â  // (A) lastUpdatedAt / lastUpdatedBy ã‚’ä½¿ç”¨
Â  Â  Â  Â  Â  Â  Â  Â  batch.update(noteRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedBy: user.uid
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error updating timestamps:", error);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  addTaskForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const input = document.getElementById('new-task-name');
Â  Â  Â  Â  const name = input.value.trim();
Â  Â  Â  Â  if (!name) return;
Â  Â  Â  Â  // (A) ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã«ã‚‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä¿å­˜
Â  Â  Â  Â  await addDoc(tasksCollectionRef, { 
Â  Â  Â  Â  Â  Â  name, 
Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp(), 
Â  Â  Â  Â  Â  Â  lastUpdated: serverTimestamp(), 
Â  Â  Â  Â  Â  Â  lastUpdatedBy: user.uid, 
Â  Â  Â  Â  Â  Â  archived: false 
Â  Â  Â  Â  });
Â  Â  Â  Â  await updateDoc(workspaceRef, { lastUpdated: serverTimestamp(), lastUpdatedBy: user.uid });
Â  Â  Â  Â  input.value = '';
Â  Â  });
// --- Excel/CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ---
// --- Excel/CSV ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (ãƒªã‚¹ãƒˆå½¢å¼å–ã‚Šè¾¼ã¿) ---
document.getElementById('import-file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (!confirm('ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»B1ã‚»ãƒ«ï¼šãƒªã‚¹ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«\nãƒ»3è¡Œç›®ä»¥é™ï¼šå„ãƒ¡ãƒ¢é …ç›®\nã¨ã—ã¦1ã¤ã®ã‚¿ã‚¹ã‚¯å†…ã«å–ã‚Šè¾¼ã¾ã‚Œã¾ã™ã€‚')) {
            e.target.value = '';
            return;
        }

        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã¨ã—ã¦å–å¾— (ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚‚ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ‰±ã†è¨­å®š)
            const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (rows.length === 0) {
                showMessage('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', true);
                return;
            }

            // 1. è¦ªã¨ãªã‚‹ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆ
            // B1ã‚»ãƒ« (è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0, åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1) ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«ã™ã‚‹
            let taskName = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸãƒªã‚¹ãƒˆ";
            if (rows.length > 0 && rows[0] && rows[0][1]) {
                taskName = String(rows[0][1]).trim();
            } else {
                // B1ãŒç©ºã®å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const now = new Date();
                taskName = `ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒªã‚¹ãƒˆ_${now.getDate()}æ—¥${now.getHours()}æ™‚`;
            }

            // ã‚¿ã‚¹ã‚¯ã‚’ä¿å­˜
            const newTaskRef = await addDoc(collection(db, "workspaces", workspaceId, "tasks"), { 
                name: taskName, 
                createdAt: serverTimestamp(), 
                lastUpdated: serverTimestamp(), 
                lastUpdatedBy: user.uid, 
                archived: false,
                importedAuthor: null // ã‚¿ã‚¹ã‚¯è‡ªä½“ã«ã¯ç‰¹å®šã®æ‹…å½“è€…ã¯ã¤ã‘ãªã„
            });

            // 2. ä¸­èº«ã®ãƒ¡ãƒ¢ã‚’ä¸€æ‹¬ä½œæˆ
            const batch = writeBatch(db);
            let count = 0;
            const MAX_IMPORT = 450; // Firestoreã®ãƒãƒƒãƒåˆ¶é™è€ƒæ…®

            // 3è¡Œç›® (ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹2) ã‹ã‚‰ãƒ«ãƒ¼ãƒ—é–‹å§‹
            for (let i = 2; i < rows.length; i++) {
                if (count >= MAX_IMPORT) break;
                
                const row = rows[i];
                // è¡Œè‡ªä½“ãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯Aåˆ—(0ç•ªç›®)ãŒç„¡ã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!row) continue;

                const content = row[0]; // Aåˆ—: ãƒ¡ãƒ¢å†…å®¹
                const author = row[1];  // Båˆ—: æ‹…å½“è€…(æŠ•ç¨¿è€…)

                if (!content || typeof content !== 'string' || content.trim() === '') continue;

                // ãƒ¡ãƒ¢ã‚’ä½œæˆ (newTaskRef.id ã®ä¸‹ã«è¿½åŠ )
                const newNoteRef = doc(collection(db, "workspaces", workspaceId, "tasks", newTaskRef.id, "notes"));
                
                batch.set(newNoteRef, {
                    author: author ? String(author).trim() : (user.displayName || 'æ‹…å½“è€…ãªã—'), // Båˆ—ãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    content: String(content).trim(),
                    attachments: [],
                    status: 'ä½œæ¥­ä¸­',
                    parentId: null,
                    createdAt: serverTimestamp(),
                    lastUpdatedAt: serverTimestamp(),
                    lastUpdatedBy: user.uid,
                    isHighlighted: false
                });
                count++;
            }

            if (count > 0) {
                // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®æ›´æ–°æ—¥æ™‚ã‚‚æ›´æ–°
                batch.update(workspaceRef, { lastUpdated: serverTimestamp(), lastUpdatedBy: user.uid });
                
                await batch.commit();
                showMessage(`ã€Œ${taskName}ã€ã‚’ä½œæˆã—ã€${count}ä»¶ã®ãƒ¡ãƒ¢ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸã€‚`);
            } else {
                // ãƒ¡ãƒ¢ãŒ1ã¤ã‚‚ãªã‹ã£ãŸå ´åˆã§ã‚‚ã‚¿ã‚¹ã‚¯ã ã‘ã¯ã§ãã¦ã„ã‚‹ã®ã§ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showMessage(`ãƒªã‚¹ãƒˆã€Œ${taskName}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆä¸­èº«ãªã—ï¼‰ã€‚`);
            }

        } catch (error) {
            console.error("Import error:", error);
            showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
        } finally {
            e.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
        }
    });

Â  Â  noteFileInput.addEventListener('change', (e) => {
Â  Â  Â  Â  noteFiles = Array.from(e.target.files);
Â  Â  Â  Â  noteAttachmentsPreview.innerHTML = noteFiles.map(f => `<span>${escapeHtml(f.name)}</span>`).join(', ');
Â  Â  });
Â  Â  notesList.addEventListener('change', (e) => {
Â  Â  Â  Â  if (e.target.classList.contains('comment-file-input')) {
Â  Â  Â  Â  Â  Â  const form = e.target.closest('form');
Â  Â  Â  Â  Â  Â  const parentId = form.dataset.parentId;
Â  Â  Â  Â  Â  Â  commentFiles[parentId] = Array.from(e.target.files);
Â  Â  Â  Â  Â  Â  const preview = form.querySelector('.comment-attachments-preview');
Â  Â  Â  Â  Â  Â  preview.innerHTML = commentFiles[parentId].map(f => `<span>${escapeHtml(f.name)}</span>`).join(', ');
Â  Â  Â  Â  }
});
Â  // âœ¨ æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç† âœ¨
    const refreshBtn = document.getElementById('refresh-notes-btn');
    refreshBtn.addEventListener('click', () => {
        if (hasPendingUpdate && latestNotesSnapshot) {
            console.log("Applying latest snapshot via refresh button...");
            handleNotesSnapshot(latestNotesSnapshot); // ä¿å­˜ã—ã¦ãŠã„ãŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§æç”»
            hasPendingUpdate = false;           // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            // latestNotesSnapshot ã¯æ¬¡ã®æ›´æ–°ã¾ã§ä¿æŒ (null ã«ã—ãªã„)
            refreshBtn.classList.add('hidden'); // ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«
        }
    });
Â  Â  async function uploadFiles(files, taskId) {
Â  Â  Â  Â  const uploadPromises = files.map(file => {
Â  Â  Â  Â  Â  Â  const storageRef = ref(storage, `${workspaceId}/${taskId}/${Date.now()}_${file.name}`);
Â  Â  Â  Â  Â  Â  return uploadBytes(storageRef, file).then(snapshot => getDownloadURL(snapshot.ref));
Â  Â  Â  Â  });
Â  Â  Â  Â  const urls = await Promise.all(uploadPromises);
Â  Â  Â  Â  return files.map((file, index) => ({ name: file.name, url: urls[index] }));
Â  Â  }

Â  Â  noteForm.addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const author = authorInput.value.trim();
Â  Â  Â  Â  const content = document.getElementById('note-textarea').value.trim();
Â  Â  Â  Â  if (!currentTask || (!content && noteFiles.length === 0) || !author) {
Â  Â  Â  Â  Â  Â  showMessage('æŠ•ç¨¿è€…åã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const attachments = noteFiles.length > 0 ? await uploadFiles(noteFiles, currentTask.id) : [];
Â  Â  Â  Â  
Â  Â  Â  Â  const notesCollectionRef = collection(db, "workspaces", workspaceId, "tasks", currentTask.id, "notes");
Â  Â  Â  Â  await addDoc(notesCollectionRef, {
Â  Â  Â  Â  Â  Â  author, content, attachments,
Â  Â  Â  Â  Â  Â  status: document.getElementById('status-select').value,
Â  Â  Â  Â  Â  Â  parentId: null,
Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  // (A) ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä¿å­˜
Â  Â  Â  Â  Â  Â  lastUpdatedAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  lastUpdatedBy: user.uid,
 Â  Â  Â  Â  Â  isHighlighted: false
Â  Â  Â  Â  });
Â  Â  Â  Â  // (E) è¦ªãƒ¡ãƒ¢ä½œæˆæ™‚ã¯ã€è¦ªãƒ¡ãƒ¢è‡ªä½“ã®IDã‚’æ¸¡ã™å¿…è¦ã¯ãªã„ï¼ˆã‚¿ã‚¹ã‚¯ã ã‘æ›´æ–°ï¼‰
Â  Â  Â  Â  await updateTaskTimestamp(currentTask.id);
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('note-textarea').value = '';
Â  Â  Â  Â  noteFiles = [];
Â  Â  Â  Â  noteAttachmentsPreview.innerHTML = '';
Â  Â  Â  Â  noteFileInput.value = '';
Â  Â  });

Â  Â  notesList.addEventListener('submit', async (e) => {
Â  Â  Â  Â  if (e.target.classList.contains('comment-form')) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const form = e.target;
Â  Â  Â  Â  Â  Â  const parentId = form.dataset.parentId;
Â  Â  Â  Â  Â  Â  const author = authorInput.value.trim();
Â  Â  Â  Â  Â  Â  const content = form.querySelector('.comment-input').value.trim();
Â  Â  Â  Â  Â  Â  const files = commentFiles[parentId] || [];

Â  Â  Â  Â  Â  Â  if (!currentTask || (!content && files.length === 0) || !author) {
Â  Â  Â  Â  Â  Â  Â  Â  showMessage('æŠ•ç¨¿è€…åã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const attachments = files.length > 0 ? await uploadFiles(files, currentTask.id) : [];
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const notesCollectionRef = collection(db, "workspaces", workspaceId, "tasks", currentTask.id, "notes");
Â  Â  Â  Â  Â  Â  await addDoc(notesCollectionRef, {
Â  Â  Â  Â  Â  Â  Â  Â  author, content, attachments, parentId, status: '', 
Â  Â  Â  Â  Â  Â  Â  Â  createdAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  // (A) ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä¿å­˜
Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedBy: user.uid
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  // (E) ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ æ™‚ã¯ã€è¦ªãƒ¡ãƒ¢ID (parentId) ã‚’æ¸¡ã™
Â  Â  Â  Â  Â  Â  await updateTaskTimestamp(currentTask.id, parentId);

Â  Â  Â  Â  Â  Â  form.reset();
Â  Â  Â  Â  Â  Â  commentFiles[parentId] = [];
Â  Â  Â  Â  Â  Â  form.querySelector('.comment-attachments-preview').innerHTML = '';
Â  Â  Â  Â  }
Â  Â  });
Â  Â  
Â  Â  notesList.addEventListener('click', async (e) => {
Â  Â  Â  Â  const editBtn = e.target.closest('.edit-btn');
Â  Â  Â  Â  const deleteBtn = e.target.closest('.delete-btn');
Â  Â  
Â  Â  Â  Â  const highlightBtn = e.target.closest('.highlight-btn');
Â  Â  Â  Â  const quickReplyBtn = e.target.closest('.quick-reply-btn');

Â  Â  Â  Â  if(quickReplyBtn) {
Â  Â  Â  Â  Â  Â  const form = quickReplyBtn.closest('form');
Â  Â  Â  Â  Â  Â  form.querySelector('.comment-input').value = 'äº†è§£ã§ã™';
Â  Â  Â  Â  Â  Â  form.querySelector('button[type="submit"]').click();
Â  Â  Â  Â  }

Â  Â  Â  Â  if (highlightBtn) {
Â  Â  Â  Â  Â  Â  const noteId = highlightBtn.dataset.noteId;
Â  Â  Â  Â  Â  Â  const noteRef = doc(db, "workspaces", workspaceId, "tasks", currentTask.id, "notes", noteId);
Â  Â  Â  Â  Â  Â  const docSnap = await getDoc(noteRef);
Â  Â  Â  Â  Â  Â  if (docSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  // (A) ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(noteRef, { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isHighlighted: !docSnap.data().isHighlighted,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedBy: user.uid
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  // (E) æ³¨ç›®ã¯è¦ªãƒ¡ãƒ¢ã®ã¿ãªã®ã§ã€noteId ã‚’ãã®ã¾ã¾æ¸¡ã™
Â  Â  Â  Â  Â  Â  Â  Â  await updateTaskTimestamp(currentTask.id, noteId);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (editBtn) {
Â  Â  Â  Â  Â  Â  const noteId = editBtn.dataset.noteId;
Â  Â  Â  Â  Â  Â  const noteElement = document.getElementById(`note-${noteId}`);
Â  Â  Â  Â  Â  Â  const contentP = noteElement.querySelector('.note-content');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (noteElement.querySelector('.edit-area')) return;

Â  Â  Â  Â  Â  Â  // (B) ç·¨é›†é–‹å§‹
Â  Â  Â  Â  Â  Â  setEditingStatus(true);

Â  Â  Â  Â  Â  Â  const currentContent = contentP.innerText;
Â  Â  Â  Â  Â  Â  contentP.style.display = 'none';

Â  Â  Â  Â  Â  Â  const editArea = document.createElement('div');
Â  Â  Â  Â  Â  Â  editArea.className = 'edit-area mt-2';
Â  Â  Â  Â  Â  Â  editArea.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <textarea class="w-full border rounded p-2 text-sm">${currentContent}</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right mt-2 space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="save-edit-btn px-3 py-1 bg-blue-500 text-white rounded text-xs">ä¿å­˜</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="cancel-edit-btn px-3 py-1 bg-gray-300 rounded text-xs">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  contentP.after(editArea);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  editArea.querySelector('.save-edit-btn').onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  const newContent = editArea.querySelector('textarea').value;
Â  Â  Â  Â  Â  Â  Â  Â  const noteRef = doc(db, "workspaces", workspaceId, "tasks", currentTask.id, "notes", noteId);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // (E) è¦ªIDã‚’ç‰¹å®šã™ã‚‹ãŸã‚
Â  Â  Â  Â  Â  Â  Â  Â  const noteDoc = await getDoc(noteRef);
Â  Â  Â  Â  Â  Â  Â  Â  const parentId = noteDoc.exists() ? noteDoc.data().parentId : null;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (newContent.trim() !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (A) ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(noteRef, { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  content: newContent.trim(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedAt: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastUpdatedBy: user.uid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (E) ç·¨é›†æ™‚ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã‚‰parentIdã‚’ã€è¦ªãƒ¡ãƒ¢ãªã‚‰noteIdã‚’æ¸¡ã™
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateTaskTimestamp(currentTask.id, parentId || noteId);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â   editArea.remove();
Â  Â  Â  Â  Â  Â  Â  Â  contentP.style.display = '';
Â  Â  Â  Â  Â  Â  Â  Â  // (B) ç·¨é›†çµ‚äº†
Â  Â  Â  Â  Â  Â  Â  Â  setEditingStatus(false);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  editArea.querySelector('.cancel-edit-btn').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  // (B) ç·¨é›†çµ‚äº†
Â  Â  Â  Â  Â  Â  Â  Â  setEditingStatus(false);
Â  Â  Â  Â  Â  Â  Â  Â  editArea.remove();
Â  Â  Â  Â  Â  Â  Â  Â  contentP.style.display = '';
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  if (deleteBtn) {
Â  Â  Â  Â  Â  Â  const noteId = deleteBtn.dataset.noteId;
Â  Â  Â  Â  Â  Â  if (confirm('ã“ã®ãƒ¡ãƒ¢ï¼ˆã¨è¿”ä¿¡ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
Â  Â  Â  Â  Â  Â  Â  Â  // (C) ãƒãƒƒãƒå‡¦ç†ã‚’ try ã®ç›´å‰ï¼ˆconfirm ã®å†…å´ï¼‰ã§å®šç¾©
Â  Â  Â  Â  Â  Â  Â  Â  const batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteRef = doc(db, "workspaces", workspaceId, "tasks", currentTask.id, "notes", noteId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (E) å‰Šé™¤å‰ã«è¦ªIDã‚’ç‰¹å®š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const noteDoc = await getDoc(noteRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let parentIdToUpdate = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (noteDoc.exists() && noteDoc.data().parentId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parentIdToUpdate = noteDoc.data().parentId;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. æœ¬ä½“ã‚’å‰Šé™¤ãƒãƒƒãƒã«è¿½åŠ 
 Â  Â  Â  Â  Â  Â  Â  Â  batch.delete(noteRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. å­ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆè¿”ä¿¡ï¼‰ã‚‚ã™ã¹ã¦å‰Šé™¤ãƒãƒƒãƒã«è¿½åŠ  (Cã®è¦ä»¶å……è¶³)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const repliesQuery = query(collection(db, "workspaces", workspaceId, "tasks", currentTask.id, "notes"), where("parentId", "==", noteId));
 Â  Â  Â  Â  Â  Â  Â  Â  const repliesSnapshot = await getDocs(repliesQuery);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  repliesSnapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.delete(doc.ref);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // (E) å‰Šé™¤æ™‚ã€ã‚³ãƒ¡ãƒ³ãƒˆãªã‚‰è¦ªIDã‚’ã€è¦ªãƒ¡ãƒ¢ãªã‚‰ null (ã‚¿ã‚¹ã‚¯ã®ã¿æ›´æ–°) ã‚’æ¸¡ã™
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateTaskTimestamp(currentTask.id, parentIdToUpdate);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error deleting note(s):", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', true);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  });
// public/index.html ã® 1011è¡Œç›®ã‚ãŸã‚Šã«ã€ã“ã‚Œã‚’è¿½åŠ 
notesList.addEventListener('change', async (e) => {
    if (e.target.classList.contains('status-changer')) {
        const statusChanger = e.target;
        const noteId = statusChanger.dataset.noteId;
        const newStatus = statusChanger.value;
        const noteRef = doc(db, "workspaces", workspaceId, "tasks", currentTask.id, "notes", noteId);
        
        await updateDoc(noteRef, { 
            status: newStatus,
            lastUpdatedAt: serverTimestamp(),
            lastUpdatedBy: user.uid
        });
        
        await updateTaskTimestamp(currentTask.id, noteId);
    }
});
Â  }


</script>
</body>
</html>